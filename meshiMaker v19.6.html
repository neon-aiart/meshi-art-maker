<!DOCTYPE html>
<!--
* ==============================================================================
 * IMPORTANT NOTICE / é‡è¦äº‹é …
 * ==============================================================================
 * Copyright (c) 2025-2026 ã­ãŠã‚“ (Neon)
 * Licensed under the PolyForm Noncommercial License 1.0.0.
 * https://polyformproject.org/licenses/noncommercial/1.0.0/
 * [JP] æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ï¼ˆHTML/CSS/JSï¼‰ã¯ã€å€‹äººåˆ©ç”¨ãƒ»éå–¶åˆ©ç›®çš„ã§ã®ã¿ä½¿ç”¨ãƒ»æ”¹å¤‰ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚
 * ç„¡æ–­ã§ã®å†å…¬é–‹ï¼ˆãƒŸãƒ©ãƒ¼ã‚µã‚¤ãƒˆã€è»¢è¼‰ï¼‰ã€ä½œè€…åã®æ›¸ãæ›ãˆã€ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã®å‰Šé™¤ã¯å›ºãç¦ã˜ã¾ã™ã€‚
 * æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ”¹å¤‰ãƒ»é…å¸ƒï¼ˆãƒ•ã‚©ãƒ¼ã‚¯ï¼‰ã™ã‚‹å ´åˆã¯ã€å¿…ãšå…ƒã®ä½œè€…åï¼ˆã­ãŠã‚“ï¼‰
 * ãŠã‚ˆã³ã“ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨è¨˜ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
 * [EN] The code of this application (HTML/CSS/JS) is licensed for personal 
 * and non-commercial use only. Unauthorized re-uploading, mirroring, 
 * modification of authorship, or removal of author credits is strictly prohibited. 
 * If you fork this project, you MUST retain the original credits and authorship.
 * ==============================================================================
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ½ï¸ é£¯ãƒ†ãƒ­ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <!-- Tailwind CSSã®CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³ã®CDNã‚’èª­ã¿è¾¼ã¿ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Firebase Libraries -->
    <script type="module">
        // Firebaseã®å„æ©Ÿèƒ½ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Global Variables (Provided by Canvas) ---
        // ã“ã‚Œã‚‰ã®å¤‰æ•°ã¯Canvasç’°å¢ƒã‹ã‚‰è‡ªå‹•ã§æä¾›ã•ã‚Œã‚‹ãŸã‚ã€ç·¨é›†ã—ãªã„ã§ãã ã•ã„ã€‚
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : '';

        // Firebaseã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’è¨­å®š
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
        };

        // FirebaseåˆæœŸåŒ–
        window.app = initializeApp(firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        setLogLevel('debug');

        // Custom tokenã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€å¤±æ•—ã—ãŸã‚‰åŒ¿åã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
        if (initialAuthToken.length > 0) {
            signInWithCustomToken(window.auth, initialAuthToken).catch((error) => {
                console.error("Custom token sign-in failed:", error);
                signInAnonymously(window.auth);
            });
        } else {
            signInAnonymously(window.auth);
        }
    </script>
    <style>
        /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #E4E4E7;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 2rem 1rem;
        }
        /* ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .container {
            width: 100%;
            max-width: 900px;
            padding: 2rem;
            background-color: #27273d;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25), 0 6px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        /* ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ‰ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading-dots {
            font-size: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loading-dots span {
            animation: pulse-dot 1.4s infinite;
            margin: 0 0.5rem;
            animation-delay: -0.6s;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: -0.3s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0s;
        }
        @keyframes pulse-dot {
            0%, 100% { transform: scale(0.7); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        /* ç”»åƒã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-card {
            background-color: #3b3b5c;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s ease;
        }
        .image-card.selected {
            border-color: #f59e0b;
        }
        .image-card img {
            width: 100%;
            height: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        .image-card:hover img {
            transform: scale(1.05);
        }
        /* ç”»åƒã«é‡ã­ã¦è¡¨ç¤ºã™ã‚‹ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .image-overlay {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 3rem;    /* 48px ç¨‹åº¦ */
            height: 3rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
            z-index:10;
        }
        .image-overlay .material-icons {
            transform: translate(0px, 0px); /* ã‚¢ã‚¤ã‚³ãƒ³ä½ç½®ã®å¾®èª¿æ•´ */
        }
        .image-overlay:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµæœè¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .prompt-result-box {
            background-color: #3b3b5c;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            word-wrap: break-word;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative; /* ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®é…ç½®ã®ãŸã‚è¿½åŠ  */
        }
        #resultText {
            white-space: pre-wrap;
            /* ãƒœã‚¿ãƒ³ãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã«ä¸Šã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            padding-top: 4rem; 
        }
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            top: 150%; 
            left: 50%;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem; 
            font-weight: 400; 
        }
        .tooltip .tooltiptext.info-tooltip {
            width: 420px;
            margin-left: -240px;
        }
        .tooltip .tooltiptext.action-tooltip {
            width: auto; 
            white-space: nowrap; 
            right: 0;        /* å³ç«¯ã‚’è¦ªè¦ç´ ã«åˆã‚ã›ã‚‹ */
            left: auto;      /* leftã®æŒ‡å®šã‚’è§£é™¤ */
            transform: none; /* transformã‚’è§£é™¤ */
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            bottom: 100%; 
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #555 transparent;
            right: auto;     /* å³ã‹ã‚‰ã®ä½ç½®ã‚’æŒ‡å®š */
            left: 240px;     /* leftã®æŒ‡å®šã‚’è§£é™¤ */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .llm-button:disabled {
            background-color: #4a4a4a !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .llm-button:disabled:hover {
            background-color: #4a4a4a !important;
            transform: none !important;
        }
        .llm-select:disabled {
            background-color: #4a4a4a !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å³ç«¯ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .select-icon {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 flex items-center justify-center gap-2">
                <span>ğŸ½ï¸ é£¯ãƒ†ãƒ­ãƒ¡ãƒ¼ã‚«ãƒ¼</span>
                <span id="app-version" class="text-lg text-gray-400"></span>
                <div class="tooltip">
                    <span class="material-icons text-gray-400 cursor-pointer text-2xl">info</span>
                    <span class="tooltiptext info-tooltip" style="text-align: left; padding: 10px; white-space: normal; line-height: 1.6;">
                        <b>âœ¨ä½¿ã„æ–¹âœ¨</b><br>
                        1. é£Ÿæ¬²ã‚’ããã‚‰ã‚Œã‚‹æ–™ç†åã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>
                        2. ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåˆæœŸå€¤ï¼šãƒ•ãƒ¼ãƒ‰ãƒ–ãƒ­ã‚°é¢¨ï¼‰ã‚„èƒŒæ™¯ï¼ˆç©ºæ¬„ã¯æ˜ã‚‹ã„ã‚«ãƒ•ã‚§ï¼‰ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ã‚ˆã‚Šå‡ã£ãŸç”»åƒãŒç”Ÿæˆã•ã‚Œã‚„ã™ããªã‚Šã¾ã™ã€‚<br>
                        3. ã€Œé£¯ãƒ†ãƒ­ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚<br>
                        4. ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‹ã‚‰ï¼‘æšé¸ã‚“ã§ã€é£Ÿãƒ¬ãƒã‚„çŒ®ç«‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚<br>
                        â€»æ–‡å­—æ•°ã¯æŒ‡å®šã‚ˆã‚Šå¤šã‚ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
                        5. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ã€ç”»åƒç”Ÿæˆã«ä½¿ã‚ã‚ŒãŸå‘ªæ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚
                    </span>
                </div>
                <div class="tooltip">
                    <span class="material-icons text-gray-400 cursor-pointer text-2xl">copyright</span>
                    <span class="tooltiptext info-tooltip" style="text-align: left; padding: 10px; white-space: normal; line-height: 1.6;">
                        <h3 class="text-lg font-bold mb-2 text-white text-left">è‘—ä½œæ¨©æƒ…å ± / Copyright</h3>
                        <div class="text-gray-300 text-left text-sm">
                            <p class="font-bold">Copyright (c) 2025-2026 ã­ãŠã‚“ (Neon)</p>

                            <p class="mt-2 font-bold">åŸºæœ¬ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ / License:</p>
                            <p>PolyForm Noncommercial License 1.0.0</p>
                            <p class="text-xs text-gray-400 italic">https://polyformproject.org/licenses/noncommercial/1.0.0/</p>

                            <p class="mt-2 font-bold">â–  åˆ©ç”¨ä¸Šã®ãƒ«ãƒ¼ãƒ« (JP)</p>
                            <p>1. <strong>éå–¶åˆ©é™å®š:</strong> æœ¬ã‚¢ãƒ—ãƒªã¯å€‹äººåˆ©ç”¨ãƒ»éå–¶åˆ©ç›®çš„ã§ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚</p>
                            <p>2. <strong>ç¦æ­¢äº‹é …:</strong> å–¶åˆ©ç›®çš„ã®åˆ©ç”¨ã€ã‚³ãƒ¼ãƒ‰ã®æ”¹å¤‰ã€ç„¡æ–­ã§ã®å†é…å¸ƒï¼ˆè»¢è¼‰ãƒ»ãƒŸãƒ©ãƒ¼ç­‰ï¼‰ã€ãŠã‚ˆã³ä½œè€…åã®æ›¸ãæ›ãˆã‚’å›ºãç¦ã˜ã¾ã™ã€‚</p>
                            <p>3. <strong>æ¨©åˆ©ã®ç¶­æŒ:</strong> æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•ç”¨ãƒ»å‚ç…§ã™ã‚‹å ´åˆã¯ã€å¿…ãšå…ƒã®ä½œè€…åï¼ˆã­ãŠã‚“ï¼‰ã¨ã“ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚</p>

                            <p class="mt-2 font-bold">â–  Usage Rules (EN)</p>
                            <p>1. <strong>Non-commercial Only:</strong> This app is for personal and non-commercial use only.</p>
                            <p>2. <strong>Prohibition:</strong> Commercial use, modification of code, unauthorized redistribution (mirroring), and claiming authorship are strictly prohibited.</p>
                            <p>3. <strong>Attribution:</strong> You must retain the original authorship and credits.</p>

                            <p class="mt-2 font-bold">â–  ç”Ÿæˆã—ãŸAIã‚¤ãƒ©ã‚¹ãƒˆã«ã¤ã„ã¦ / Generated Images</p>
                            <p>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨è¨˜ä¸è¦ã€‚SNSæŠ•ç¨¿æ™‚ã¯AIã‚¿ã‚°æ¨å¥¨ã€‚Googleã®åˆ©ç”¨è¦ç´„ã‚’é †å®ˆã—ã¦ãã ã•ã„ã€‚</p>
                            <p class="text-xs">No credit required. AI tags are recommended for SNS. Please comply with Google's Terms of Service.</p>
                        </div>
                    </span>
                </div>
            </h1>
            <p class="text-gray-400">
                æœ€é«˜ã®é£¯ãƒ†ãƒ­ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ã‚ˆâœ¨<br>
                ä¾‹ï¼šãƒ©ãƒ¼ãƒ¡ãƒ³ã€ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ•ã‚§ã€ãƒãƒ¼ã‚ºãƒãƒ¼ã‚¬ãƒ¼
            </p>
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¡¨ç¤º -->
            <div class="text-sm text-gray-500 mt-2" hidden>
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="userIdDisplay" class="text-xs break-all">èªè¨¼ä¸­...</span>
            </div>
        </header>

        <div class="flex flex-col space-y-4">
            <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã¨ç”Ÿæˆãƒœã‚¿ãƒ³ -->
            <div class="flex flex-row space-x-4">
                <input type="text" id="promptInput" placeholder="ä¾‹ï¼šãƒ©ãƒ¼ãƒ¡ãƒ³ã€ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ•ã‚§ã€ãƒãƒ¼ã‚ºãƒãƒ¼ã‚¬ãƒ¼" autocomplete="off" class="text-input flex-grow bg-gray-700 p-3 rounded-full text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-500">
                <button id="generateBtn" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 px-8 rounded-full shadow-lg transform transition-transform duration-200 hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    é£¯ãƒ†ãƒ­ç”Ÿæˆ
                </button>
            </div>
            <!-- è©³ç´°è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div id="advancedOptions" class="grid grid-cols-[1fr_2fr] gap-4">
                <div class="relative">
                    <select id="styleSelect" class="w-full bg-gray-700 p-3 rounded-full text-white border border-gray-600 appearance-none focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="default">ã‚¹ã‚¿ã‚¤ãƒ« ï¼ˆä»»æ„ï¼‰</option>
                        <option value="photorealistic">ãƒªã‚¢ãƒ«ãªå†™çœŸé¢¨</option>
                        <option value="cinematic">æ˜ ç”»ã®ãƒ¯ãƒ³ã‚·ãƒ¼ãƒ³é¢¨</option>
                        <option value="anime">ã‚¢ãƒ‹ãƒ¡ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆé¢¨</option>
                        <option value="food-blogger" selected>ãƒ•ãƒ¼ãƒ‰ãƒ–ãƒ­ã‚°é¢¨</option>
                        <option value="dark-moody">ãƒ€ãƒ¼ã‚¯ã§é›°å›²æ°—é‡è¦–</option>
                    </select>
                    <span class="material-icons select-icon">keyboard_arrow_down</span>
                </div>
                <input type="text" id="backgroundInput" placeholder="èƒŒæ™¯ã‚„é›°å›²æ°— ï¼ˆä¾‹: å¤œæ™¯ã€é«˜ç´šãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€æ˜ã‚‹ã„ã‚«ãƒ•ã‚§ï¼‰" autocomplete="off" class="text-input w-full bg-gray-700 p-3 rounded-full text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-500">
            </div>
            <!-- ã‚·ã‚§ãƒ•ã®æ°—ã¾ãã‚Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <span>ğŸ‘©ğŸ»â€ğŸ³ ã‚·ã‚§ãƒ•ã®æ°—ã¾ãã‚Œãƒ¡ãƒ‹ãƒ¥ãƒ¼: </span>
            <div class="flex flex-row text-sm space-x-2 justify-center">
                <button id="todaySpecialBtn" class="bg-fuchsia-400 hover:bg-fuchsia-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg transform transition-transform duration-200 hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    ğŸ“… æœ¬æ—¥ã®è¨˜å¿µæ—¥
                </button>
                <button id="seasonalSpecialBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transform transition-transform duration-200 hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    ğŸŒ¸ å­£ç¯€ã®å½©ã‚Š
                </button>
                <button id="trendSpecialBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transform transition-transform duration-200 hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    âš¡ æœ€è¿‘ã®ãƒˆãƒ¬ãƒ³ãƒ‰
                </button>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div id="loadingIndicator" class="flex flex-col justify-center items-center h-32 hidden">
            <div class="loading-dots">
                <span class="text-2xl">ğŸ£</span>
                <span class="text-2xl">ğŸ</span>
                <span class="text-2xl">ğŸ¥</span>
            </div>
            <p class="mt-4 text-gray-400">ç”»åƒã‚’ç”Ÿæˆä¸­ã ã‚ˆ...å°‘ã—å¾…ã£ã¦ã¦ã­ã€‚</p>
        </div>

        <!-- ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ã‚°ãƒªãƒƒãƒ‰ -->
        <div id="imageGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4">
        </div>

        <!-- Firebaseåˆ©ç”¨çŠ¶æ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="firebaseUsageInfo" class="space-y-4 p-6 bg-[#3b3b5c] rounded-lg" hidden>
            <h2 class="text-2xl font-bold text-center">âœ¨ Firebaseåˆ©ç”¨çŠ¶æ³ã®ç›®å®‰ âœ¨</h2>
            <p class="text-center text-gray-400 text-sm">
                ã“ã‚Œã¯Firebaseã®ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆSparkãƒ—ãƒ©ãƒ³ï¼‰ã®ä¸€èˆ¬çš„ãªåˆ¶é™ã§ã™ã€‚<br>
                æ­£ç¢ºãªä½¿ç”¨çŠ¶æ³ã¯<a href="https://console.firebase.google.com/" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline">Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«</a>ã«ã‚¢ã‚¯ã‚»ã‚¹å¾Œã€ã”è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã®ã€Œä½¿ç”¨çŠ¶æ³ã€ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Firestore æƒ…å ± -->
                <div class="p-4 bg-[#27273d] rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Cloud Firestore</h3>
                    <ul class="space-y-1 text-sm text-gray-300">
                        <li><span class="font-semibold">æœ€å¤§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸:</span> 1 GiB</li>
                        <li><span class="font-semibold">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€ä¿¡:</span> 10 GiB / æœˆ</li>
                        <li><span class="font-semibold">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿å–ã‚Š:</span> 50,000 / æ—¥</li>
                        <li><span class="font-semibold">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›¸ãè¾¼ã¿:</span> 20,000 / æ—¥</li>
                        <li><span class="font-semibold">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤:</span> 20,000 / æ—¥</li>
                    </ul>
                </div>

                <!-- Cloud Storage æƒ…å ± -->
                <div class="p-4 bg-[#27273d] rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Cloud Storage</h3>
                    <ul class="space-y-1 text-sm text-gray-300">
                        <li><span class="font-semibold">æœ€å¤§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸:</span> 5 GiB</li>
                        <li><span class="font-semibold">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:</span> 1 GB / æ—¥</li>
                        <li><span class="font-semibold">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ“ä½œ:</span> 20,000 / æ—¥</li>
                        <li><span class="font-semibold">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ“ä½œ:</span> 50,000 / æ—¥</li>
                    </ul>
                </div>
            </div>
            <p class="text-xs text-gray-500 text-center pt-2">
                â€» ã“ã‚Œã‚‰ã®å€¤ã¯å‹•çš„ã«å–å¾—ã•ã‚ŒãŸç¾åœ¨å€¤ã§ã¯ãªãã€ãƒ—ãƒ©ãƒ³ã«åŸºã¥ã„ãŸé™çš„ãªä¸Šé™å€¤ã§ã™ã€‚ç¾åœ¨ä½¿ç”¨é‡ã‚„æ®‹ã‚Šå®¹é‡ã¯è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚
            </p>
        </div>

        <!-- è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆé£Ÿãƒ¬ãƒãƒ»çŒ®ç«‹ã‚¢ã‚¤ãƒ‡ã‚¢ï¼‰ -->
        <div id="additionalContent" class="flex flex-col space-y-4 hidden">
            <div id="llmButtons" class="flex flex-wrap justify-center items-center space-x-4 mb-4">
                <button id="reviewBtn" class="llm-button bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-full transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                    ğŸ“ é£Ÿãƒ¬ãƒç”Ÿæˆ
                </button>
                <div class="relative inline-block">
                    <span class="text-gray-400">æ–‡å­—æ•°ï¼š</span>
                    <select id="lengthSelect" class="llm-select bg-gray-700 text-white rounded-full px-4 py-2 text-sm appearance-none pr-8 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <option value="150">150</option>
                        <option value="200" selected>200</option>
                        <option value="250">250</option>
                        <option value="300">300</option>
                        <option value="350">350</option>
                        <option value="400">400</option>
                        <option value="450">450</option>
                        <option value="500">500</option>
                    </select>
                    <span class="material-icons select-icon text-base">keyboard_arrow_down</span>
                </div>
                <span class="text-gray-400 flex items-center space-x-2"> | </span>
                <button id="menuBtn" class="llm-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-full transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
                    ğŸ½ï¸ çŒ®ç«‹ã‚¢ã‚¤ãƒ‡ã‚¢
                </button>
                <span class="text-gray-400 flex items-center space-x-2"> | </span>
                <div class="tooltip">
                    <button id="promptCopyBtn" class="w-10 h-10 rounded-full text-gray-400 hover:bg-gray-700 transition-colors">
                        <span class="material-icons text-lg">article</span>
                    </button>
                    <span class="tooltiptext action-tooltip">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼</span>
                </div>
            </div>

            <!-- LLMã‹ã‚‰ã®å›ç­”è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ -->
            <div id="promptResultBox" class="prompt-result-box hidden">
                <div id="textLoadingIndicator" class="flex flex-col justify-center items-center h-full p-4 hidden">
                    <div class="loading-dots">
                        <span class="text-2xl">ğŸ›</span>
                        <span class="text-2xl">ğŸ”</span>
                        <span class="text-2xl">ğŸ°</span>
                    </div>
                    <p class="mt-4 text-gray-400">æ–‡ç« ã‚’ç”Ÿæˆä¸­ã ã‚ˆ...å°‘ã—å¾…ã£ã¦ã¦ã­ã€‚</p>
                </div>
                <div class="absolute top-2 right-2 z-10 flex space-x-1">
                    <div class="tooltip">
                        <button id="kansaiToggleBtn" class="llm-button w-10 h-10 text-gray-400 hover:bg-gray-700 font-semibold py-0 px-2 rounded-full transition-colors hidden">
                            <span class="material-symbols-outlined"></span> è¥¿
                        </button>
                        <span class="tooltiptext action-tooltip">é–¢è¥¿å¼</span>
                    </div>
                    <div class="tooltip">
                        <button id="hakataToggleBtn" class="llm-button w-10 h-10 text-gray-400 hover:bg-gray-700 font-semibold py-0 px-2 rounded-full transition-colors hidden">
                            <span class="material-symbols-outlined"></span> åš
                        </button>
                        <span class="tooltiptext action-tooltip">åšå¤šå¼</span>
                    </div>
                    <div class="tooltip">
                        <button id="tsugaruToggleBtn" class="llm-button w-10 h-10 text-gray-400 hover:bg-gray-700 font-semibold py-0 px-2 rounded-full transition-colors hidden">
                            <span class="material-symbols-outlined"></span>æ´¥
                        </button>
                        <span class="tooltiptext action-tooltip">æ´¥è»½å¼</span>
                    </div>
                    <div class="tooltip">
                        <button id="uchinaguchiToggleBtn" class="llm-button w-10 h-10 text-gray-400 hover:bg-gray-700 font-semibold py-0 px-2 rounded-full transition-colors hidden">
                            <span class="material-symbols-outlined"></span> æ²–
                        </button>
                        <span class="tooltiptext action-tooltip">ã†ã¡ãªãƒ¼ãã¡</span>
                    </div>
                    <div class="tooltip">
                        <button id="galmojiToggleBtn" class="llm-button w-10 h-10 text-gray-400 hover:bg-gray-700 font-semibold py-2 px-2 rounded-full transition-colors hidden">
                            <span class="material-icons text-lg">favorite</span>
                        </button>
                        <span class="tooltiptext action-tooltip">ã‚®ãƒ£ãƒ«æ–‡å­—</span>
                    </div>
                    <div class="tooltip">
                        <button id="copyBtn" class="llm-button p-2 w-10 h-10 rounded-full text-gray-400 hover:bg-gray-700 transition-colors hidden">
                            <span class="material-icons text-lg">content_copy</span>
                        </button>
                        <span id="copyBtnTooltip" class="tooltiptext action-tooltip">é£Ÿãƒ¬ãƒã‚³ãƒ”ãƒ¼</span>
                    </div>
                </div>
                <div id="tempMessage" class="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-gray-800 text-white rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 pointer-events-none hidden"></div>
                <!-- LLMã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ† -->
                <div id="resultText" class="p-4"></div>
                <!-- æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ -->
                <div id="charCount" class="text-xs text-gray-500 text-right px-4 pb-2"></div>
            </div>
        </div>
    </div>

    <script type="module">
        /* Copyright (c) 2025-2026 ã­ãŠã‚“ / Licensed under PolyForm Noncommercial 1.0.0 (https://polyformproject.org/licenses/noncommercial/1.0.0/) */
        const APP_VERSION = '19.6';

        // Firebaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- å®šæ•°ã¨UIè¦ç´ ã®å–å¾— ---
        const API_KEY = ""; // APIã‚­ãƒ¼ã¯Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã®ã§ç©ºã®ã¾ã¾ã§OK
        const TRANSLATION_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
        const LLM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const IMAGE_COUNT = 4; // ä¸€åº¦ã«ç”Ÿæˆã™ã‚‹ç”»åƒã®æ•°

        // HTMLã‹ã‚‰æ“ä½œã—ãŸã„è¦ç´ ã‚’ã¾ã¨ã‚ã¦å–å¾—
        document.title = `ğŸ½ï¸ é£¯ãƒ†ãƒ­ãƒ¡ãƒ¼ã‚«ãƒ¼ v${APP_VERSION}`;
        const appVersionSpan = document.getElementById('app-version');
        appVersionSpan.textContent = `v${APP_VERSION}`;
        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('promptInput');
        const backgroundInput = document.getElementById('backgroundInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const imageGrid = document.getElementById('imageGrid');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const additionalContent = document.getElementById('additionalContent');
        const reviewBtn = document.getElementById('reviewBtn');
        const lengthSelect = document.getElementById('lengthSelect');
        const menuBtn = document.getElementById('menuBtn');
        const promptResultBox = document.getElementById('promptResultBox');
        const resultText = document.getElementById('resultText');
        const copyBtn = document.getElementById('copyBtn');
        const textLoadingIndicator = document.getElementById('textLoadingIndicator');
        const promptCopyBtn = document.getElementById('promptCopyBtn');
        const copyBtnTooltip = document.getElementById('copyBtnTooltip'); 
        const galmojiToggleBtn = document.getElementById('galmojiToggleBtn');
        const kansaiToggleBtn = document.getElementById('kansaiToggleBtn');
        const hakataToggleBtn = document.getElementById('hakataToggleBtn');
        const tsugaruToggleBtn = document.getElementById('tsugaruToggleBtn');
        const uchinaguchiToggleBtn = document.getElementById('uchinaguchiToggleBtn');
        const todaySpecialBtn = document.getElementById('todaySpecialBtn');
        const seasonalSpecialBtn = document.getElementById('seasonalSpecialBtn');
        const trendSpecialBtn = document.getElementById('trendSpecialBtn');

        // å„ãƒœã‚¿ãƒ³ã®è¨­å®š
        kansaiToggleBtn.addEventListener('click', () => handleDialectClick('é–¢è¥¿å¼', kansaiToggleBtn, 'text-emerald-400'));
        hakataToggleBtn.addEventListener('click', () => handleDialectClick('åšå¤šå¼', hakataToggleBtn, 'text-purple-400'));
        tsugaruToggleBtn.addEventListener('click', () => handleDialectClick('æ´¥è»½å¼', tsugaruToggleBtn, 'text-sky-400'));
        uchinaguchiToggleBtn.addEventListener('click', () => handleDialectClick('ã†ã¡ãªãƒ¼ãã¡', uchinaguchiToggleBtn, 'text-orange-400'));

        todaySpecialBtn.addEventListener('click', () => suggestChefMenu('anniversary'));
        seasonalSpecialBtn.addEventListener('click', () => suggestChefMenu('seasonal'));
        trendSpecialBtn.addEventListener('click', () => suggestChefMenu('trend'));

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let userId = null;              // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿å­˜
        let selectedImageBase64 = null; // é¸æŠã•ã‚ŒãŸç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        let isGeneratingText = false;   // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆä¸­ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
        let currentImagePrompt = null;  // ç¾åœ¨ã®ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜
        let originalText = '';          // AIãŒç”Ÿæˆã—ãŸå…ƒã®æ–‡ç« 
        let translatedTextCache = {};
        let currentTransformMode = null;
        let toastTimeoutId = null;      // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
        let copyTimer = null;           // ã‚¢ã‚¤ã‚³ãƒ³å¾©å…ƒç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
        let originalIconContent = null; // ã‚¢ã‚¤ã‚³ãƒ³ã®åŸå‹ã‚’ä¿å­˜
        const canvasAppId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const storage = getStorage(window.app); // window.app ãŒ Firebase ã®åˆæœŸåŒ–ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ä»®å®š

        // --- Firebaseèªè¨¼ ---
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç›£è¦–ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä½¿ç”¨
                userId = user.uid || crypto.randomUUID();
                userIdDisplay.textContent = userId;
            } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ãªIDã‚’ä¸€æ™‚çš„ã«ä½¿ç”¨
                userId = crypto.randomUUID();
                userIdDisplay.textContent = userId;
            }
            generateBtn.disabled = false; // èªè¨¼ãŒå®Œäº†ã—ãŸã‚‰ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        });

        // --- APIé€šä¿¡ ---

        /**
         * APIå‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ãŸéš›ã«ã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦è©¦è¡Œã™ã‚‹é–¢æ•°
         * @param {Function} fetcher - å®Ÿè¡Œã—ãŸã„fetchå‡¦ç†
         * @param {number} maxRetries - æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°
         * @returns {Promise<Response>} fetchã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
         */
        const fetchWithRetry = async (fetcher, maxRetries = 3) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetcher();
                    if (response.ok) {
                        return response; // æˆåŠŸã—ãŸã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
                    }
                    // 401èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ãƒªãƒˆãƒ©ã‚¤ã‚’è©¦ã¿ã‚‹
                    if (response.status === 401) {
                        console.warn(`APIèªè¨¼ã‚¨ãƒ©ãƒ¼(401)ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™... (${attempt + 1}/${maxRetries})`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    console.error(`APIå‘¼ã³å‡ºã—è©¦è¡Œ ${attempt + 1}å›ç›®ã§å¤±æ•—: ${error.message}`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        // å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
                        if (error.message.includes('401')) {
                            throw new Error('APIèªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        }
                        throw error; // æœ€å¾Œã®ç‰¹å®šã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ç›´ã™
                    }
                    // ãƒªãƒˆãƒ©ã‚¤ã®é–“éš”ã‚’å¾ã€…ã«é•·ãã™ã‚‹ï¼ˆExponential Backoffï¼‰
                    const delay = 1000 * Math.pow(2, attempt);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        /**
         * ã‚·ãƒ³ãƒ—ãƒ«ãªç¿»è¨³æ©Ÿèƒ½ï¼ˆé«˜åº¦ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”ŸæˆãŒå¤±æ•—ã—ãŸæ™‚ã®äºˆå‚™ï¼‰
         * @param {string} text - ç¿»è¨³ã—ãŸã„æ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {Promise<string>} ç¿»è¨³ã•ã‚ŒãŸè‹±èªã®ãƒ†ã‚­ã‚¹ãƒˆ
         */
        const translatePrompt = async (text) => {
            const payload = {
                contents: [{ parts: [{ text: `Translate the following Japanese food name or phrase into a detailed English prompt for an image generation model: "${text}". The translation should focus on making the food look as delicious and appetizing as possible. Do not add any extra text, just the English prompt.` }] }],
                systemInstruction: {
                    parts: [{ text: "You are a professional prompt engineer for a food image generation model. Your task is to create the most appetizing and delicious-sounding English prompts based on user input." }]
                }
            };
            try {
                const response = await fetchWithRetry(() => fetch(TRANSLATION_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                const result = await response.json();
                const translatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!translatedText) throw new Error('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸ: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return translatedText;
            } catch (error) {
                console.error('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                return text; // å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
            }
        };

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰é«˜åº¦ãªç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹
         * @param {string} food - æ–™ç†å
         * @param {string} style - ã‚¹ã‚¿ã‚¤ãƒ«
         * @param {string} background - èƒŒæ™¯
         * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸè‹±èªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
         */
        const createImagePrompt = async (food, style, background) => {
            let userRequest = `æ–™ç†å: ã€Œ${food}ã€`;
            if (style && style !== 'default') {
                userRequest += `, ã‚¹ã‚¿ã‚¤ãƒ«: ã€Œ${style}ã€`;
            }
            if (background) {
                userRequest += `, èƒŒæ™¯ã‚„é›°å›²æ°—: ã€Œ${background}ã€`;
            }

            // AIã«å¯¾ã™ã‚‹è©³ç´°ãªæŒ‡ç¤ºï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            const systemPrompt = `ã‚ãªãŸã¯ã€æ–™ç†ã®å†™çœŸç”ŸæˆAIã®ãŸã‚ã®ãƒ—ãƒ­ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã€éå¸¸ã«è©³ç´°ã§ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã€ã‹ã¤é£Ÿæ¬²ã‚’ããã‚‹ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¤‰æ›ã—ã€æœ€é«˜ã®æ–™ç†ç”»åƒã‚’ç”Ÿæˆã•ã›ã‚‹ã“ã¨ãŒã‚ãªãŸã®å½¹å‰²ã§ã™ã€‚
                                ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„:
                                1. **æ–™ç†ã®åˆ†æ:** ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸæ–™ç†ã®ä¸»è¦ãªæ§‹æˆè¦ç´ ã€è³ªæ„Ÿã€ç‰¹å¾´ã‚’æ·±ãç†è§£ã—ã¦ãã ã•ã„ã€‚(ä¾‹: ã€Œãƒ©ãƒ¼ãƒ¡ãƒ³ã€ãªã‚‰ã€éººã€ã‚¹ãƒ¼ãƒ—ã€ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ã€ãƒã‚®ã€ãƒ¡ãƒ³ãƒãªã©)
                                2. **å½¢å®¹è©ã®æ´»ç”¨:** ã€Œè‰¶ã‚„ã‹ãª(glistening)ã€ã€Œæ¹¯æ°—ãŒç«‹ã¤(steaming)ã€ã€Œå®Œç’§ãªç„¼ãè‰²ã®(perfectly seared)ã€ã€Œæ¿ƒåšã§é¢¨å‘³è±Šã‹ãª(rich and savory)ã€ãªã©ã€äº”æ„Ÿã‚’åˆºæ¿€ã™ã‚‹å½¢å®¹è©ã‚’å¤šç”¨ã—ã¦ãã ã•ã„ã€‚
                                3. **ã‚¹ã‚¿ã‚¤ãƒ«ã®åæ˜ :** ã‚¹ã‚¿ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆä¾‹: cinematic, food-bloggerï¼‰ã€é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å·§ã¿ã«çµ„ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚(ä¾‹: ã€Œæ˜ ç”»çš„ãªãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°(cinematic lighting)ã€ã€Œæµ…ã„è¢«å†™ç•Œæ·±åº¦(shallow depth of field)ã€ã€Œä¿¯ç°æ’®å½±(top-down shot)ã€ã€Œè‡ªç„¶å…‰(natural light)ã€)
                                4. **ã‚·ãƒ¼ãƒ³ã®æ§‹ç¯‰:** èƒŒæ™¯ã®æƒ…å ±ã‚’å…ƒã«ã€å®Œå…¨ãªã‚·ãƒ¼ãƒ³ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç´ æã€ç…§æ˜ã€å‘¨å›²ã®ç’°å¢ƒãªã©ã‚’å…·ä½“çš„ã«è¨˜è¿°ã—ã¾ã™ã€‚
                                5. **å†™çœŸæŠ€è¡“ã®å°‚é–€ç”¨èª:** ã€Œãƒ•ã‚©ãƒˆãƒªã‚¢ãƒ«(photorealistic)ã€ã€Œè¶…ã‚·ãƒ£ãƒ¼ãƒ—ãªç„¦ç‚¹(ultra-sharp focus)ã€ã€Œ8kã€ã€Œãƒ‡ã‚¸ã‚¿ãƒ«ä¸€çœ¼ãƒ¬ãƒ•(DSLR)ã€ã€Œãƒœã‚±(bokeh)ã€ã€Œé«˜ç²¾ç´°(high detail)ã€ã¨ã„ã£ãŸå°‚é–€ç”¨èªã‚’é©åˆ‡ã«å«ã‚ã¦ãã ã•ã„ã€‚
                                6. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹é€ åŒ–:** ç‰¹ã«é‡è¦ãªè¦ç´ ã«ã¯ \`(word:1.2)\` ã®ã‚ˆã†ã«é‡ã¿ä»˜ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚
                                7. **å‡ºåŠ›å½¢å¼:** æœ€çµ‚çš„ãªè‹±èªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€Œã®ã¿ã€ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã€è¨€ã„è¨³ã€å¼•ç”¨ç¬¦ãªã©ã®ä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚å‡ºåŠ›ã¯ã€ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ãŒç›´æ¥èª­ã¿è¾¼ã‚ã‚‹ã€å˜ä¸€ã®é€£ç¶šã—ãŸæ–‡å­—åˆ—ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚`;

            const payload = {
                contents: [{ parts: [{ text: userRequest }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetchWithRetry(() => fetch(TRANSLATION_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                const result = await response.json();
                const finalPrompt = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!finalPrompt) throw new Error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                console.log("ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:", finalPrompt); // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                return finalPrompt.trim();
            } catch (error) {
                console.error('é«˜åº¦ãªç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                // å¤±æ•—ã—ãŸå ´åˆã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ãªç¿»è¨³æ©Ÿèƒ½ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                return await translatePrompt(food); 
            }
        };

        // --- ç”»åƒç”Ÿæˆã¨è¡¨ç¤º ---
        /**
         * ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãƒ¡ã‚¤ãƒ³ã®é–¢æ•°
         * @param {string} prompt - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ–™ç†åãªã©ï¼‰
         */
        const generateImages = async (prompt) => {
            setGeneratingUIState(true); // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’é–‹å§‹
            currentImagePrompt = null;  // å‰å›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            let success = false;        // ç”ŸæˆãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

            try {
                // ã‚¹ã‚¿ã‚¤ãƒ«ã¨èƒŒæ™¯ã®å€¤ã‚’å–å¾—
                const style = document.getElementById('styleSelect').value;
                let background = document.getElementById('backgroundInput').value.trim();
                if (!background) {
                    // ã‚ˆãä½¿ã†ã€Œæ˜ã‚‹ã„ã‚«ãƒ•ã‚§ã€ã®è¦ç´ ã‚’è‹±èªã§è¨­å®š
                    background = 'bright cafe lighting, cinematic, shallow depth of field, warm color grading'; 
                }

                // é«˜åº¦ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
                const translatedPrompt = await createImagePrompt(prompt, style, background);
                currentImagePrompt = translatedPrompt; // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜

                const payload = { 
                    instances: { prompt: translatedPrompt }, 
                    parameters: { "sampleCount": IMAGE_COUNT } 
                };

                const response = await fetchWithRetry(() => fetch(IMAGE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                const images = result?.predictions;

                if (!images || images.length === 0) {
                    throw new Error('No images returned');
                }

                // ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„ç”»åƒã‚’è¿½åŠ 
                imageGrid.innerHTML = '';
                images.forEach(image => {
                    if (image.bytesBase64Encoded) {
                        renderImage(image.bytesBase64Encoded, prompt);
                    }
                });

                // æœ€åˆã®ç”»åƒã‚’è‡ªå‹•ã§é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                const firstImageCard = document.querySelector('.image-card');
                if (firstImageCard) {
                    firstImageCard.click();
                }

                success = true; // æˆåŠŸãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹

            } catch (error) {
                console.error('Image generation failed:', error);
                let errorMessage = 'ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                if (error.message.includes('APIèªè¨¼ã‚¨ãƒ©ãƒ¼')) {
                    errorMessage += 'APIã‚­ãƒ¼ã®å•é¡Œã€ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                } else {
                    errorMessage += `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
                imageGrid.innerHTML = `<p class="text-red-400 text-center">${errorMessage}</p>`;
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’çµ‚äº†ã—ã€ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                setGeneratingUIState(false);
                // æˆåŠŸã—ãŸå ´åˆã®ã¿ã€é£Ÿãƒ¬ãƒãªã©ã®è¿½åŠ æ©Ÿèƒ½ã‚’è¡¨ç¤º
                if (success) {
                    additionalContent.classList.remove('hidden');
                }
            }
        };

        /**
         * ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
         * @param {string} base64Data - ç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿
         * @param {string} prompt - å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
         */
        const renderImage = (base64Data, prompt) => {
            const imageUrl = `data:image/png;base64,${base64Data}`;
            const grid = imageGrid;

            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';

            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = prompt;

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'image-overlay';
            downloadBtn.innerHTML = '<span class="material-icons text-white text-3xl">download</span>';

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®å®Ÿè£…
            downloadBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹ã®ã‚’é˜²ã

                try {
                    // UIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
                    downloadBtn.style.pointerEvents = 'none';
                    downloadBtn.style.opacity = '0.5';

                    // Base64ã‚’Blobã«å¤‰æ›ï¼ˆiOSç­‰ã§ã®æˆåŠŸç‡ã‚’ä¸Šã’ã‚‹ï¼‰
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const tempUrl = URL.createObjectURL(blob);

                    // ä¸€æ™‚çš„ãªãƒªãƒ³ã‚¯ã‚’ä½œã£ã¦ã‚¯ãƒªãƒƒã‚¯
                    const a = document.createElement('a');
                    a.href = tempUrl;
                    a.download = `meshi_maker_${getFormattedDateTime()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    // ãƒ¡ãƒ¢ãƒªè§£æ”¾ã¨UIå¾©å¸°
                    setTimeout(() => URL.revokeObjectURL(tempUrl), 100);
                    // showToast('ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ', true);

                } catch (err) {
                    console.error("Download failed:", err);
                    showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
                } finally {
                    downloadBtn.style.pointerEvents = 'auto';
                    downloadBtn.style.opacity = '1';
                }
            });

            imageCard.appendChild(img);
            imageCard.appendChild(downloadBtn);
            grid.appendChild(imageCard);

            // ç”»åƒã‚«ãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
            imageCard.addEventListener('click', () => {
                if (isGeneratingText) return; // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆä¸­ã¯é¸æŠä¸å¯

                // ã™ã§ã«é¸æŠæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (imageCard.classList.contains('selected')) {
                    return;
                }

                // ä»–ã®ç”»åƒã®é¸æŠã‚’è§£é™¤ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                document.querySelectorAll('.image-card').forEach(card => card.classList.remove('selected'));
                imageCard.classList.add('selected');
                selectedImageBase64 = base64Data;
            });
        };

        function getFormattedDateTime() {
            const now = new Date();
            return `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
        }

        // --- ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        /**
         * ç”»åƒã‚’å…ƒã«ãƒ†ã‚­ã‚¹ãƒˆï¼ˆé£Ÿãƒ¬ãƒãƒ»çŒ®ç«‹ï¼‰ã‚’ç”Ÿæˆã™ã‚‹
         * @param {string} base64Data - ç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿
         * @param {string} systemPrompt - AIã¸ã®æŒ‡ç¤º
         * @param {string} userPrompt - AIã¸ã®è³ªå•
         * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
         */
        const generateTextFromImage = async (base64Data, systemPrompt, userPrompt) => {
            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const response = await fetchWithRetry(() => fetch(LLM_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }));
            const result = await response.json();
            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!generatedText) throw new Error('ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return generatedText;
        };

        /**
         * ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
         */
        const copyToClipboard = (text, buttonElement) => {
            if (!text) return;

            //  å¾“æ¥ã® textarea ã‚’ä½œã‚‹æ–¹æ³•ï¼ˆç¢ºå®Ÿã«å‹•ãï¼‰
            const textarea = document.createElement('textarea');
            textarea.value = text;
            // ç”»é¢ãŒã‚ºãƒ¬ãªã„ã‚ˆã†ã«éš ã™å·¥å¤«
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');

                // --- UIæ¼”å‡ºï¼šã‚¢ã‚¤ã‚³ãƒ³å¤‰åŒ–ï¼ˆé€£æ‰“å¯¾å¿œï¼‰ ---
                if (buttonElement) {
                    // ã™ã§ã«ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ã„ã¦ã„ã‚‹ï¼ˆé€£æ‰“ã•ã‚ŒãŸï¼‰å ´åˆã¯ã€ä¸€æ—¦ã‚¯ãƒªã‚¢ã—ã¦å³åº§ã«å…ƒã«æˆ»ã™
                    if (copyTimer) {
                        clearTimeout(copyTimer);
                        buttonElement.innerHTML = originalIconContent;
                    }

                    // ç¾åœ¨ã®ã€Œæ­£ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã€ã‚’ä¿å­˜ã—ã¦ãŠã
                    originalIconContent = buttonElement.innerHTML;

                    // ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›´ï¼ˆå‚ç›´ä½ç½®ã‚ºãƒ¬å¯¾ç­–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ ï¼‰
                    // inline-flex ã¨ items-center ã§å¼·åˆ¶çš„ã«ä¸­å¤®åŒ–ã—ã¾ã™
                    buttonElement.innerHTML = `<span class="material-icons text-green-400" style="font-size: inherit; vertical-align: middle; display: inline-flex; align-items: center;">check</span>`;

                    // 1.5ç§’å¾Œã«å…ƒã«æˆ»ã™
                    copyTimer = setTimeout(() => {
                        buttonElement.innerHTML = originalIconContent;
                        copyTimer = null;
                        originalIconContent = null;
                    }, 1500);
                }
                // showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', true);

            } catch (err) {
                console.error('Copy failed', err);
                showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', false);
            } finally {
                document.body.removeChild(textarea);
            }
        };

        // ========= ãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° =========
        // @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        // @param {boolean|null} isSuccess - æˆåŠŸã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚° (nullã®å ´åˆã¯æ¢ç´¢ä¸­)
        function showToast(msg, isSuccess) {
            const toastId = 'meshi-toast';
            console.log(`[TOAST] ${msg}`);

            if (toastTimeoutId) {
                clearTimeout(toastTimeoutId);
                toastTimeoutId = null;
            }

            // 20msé…å»¶ã•ã›ã¦ã€é‡ã„DOMæ“ä½œä¸­ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç«¶åˆã‚’å›é¿
            setTimeout(() => {
                const existingToast = document.getElementById(toastId);
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.textContent = msg;
                toast.id = toastId;
                toast.classList.add('meshi-toast');

                let bgColor;
                if (isSuccess === true) {
                    bgColor = '#007bff';
                } else if (isSuccess === false) {
                    bgColor = '#dc3545';
                } else {
                    bgColor = '#6c757d';
                }

                toast.style.cssText = `
                    position: fixed; bottom: 0px; left: 50%; transform: translateX(-50%);
                    background: ${bgColor}; color: white; padding: 4px 20px;
                    border-radius: 14px; z-index: 100000;
                    height: 24px;
                    font-size: 14px; transition: opacity 1.0s ease, transform 1.0s ease; opacity: 0;
                `;
                toast.style.display = 'flex';          // Flexboxæœ‰åŠ¹åŒ–
                toast.style.alignItems = 'center';     // å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆ
                toast.style.justifyContent = 'center'; // æ°´å¹³æ–¹å‘ã®ä¸­å¤®æƒãˆ
                document.body.appendChild(toast);

                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
                setTimeout(() => {
                    toast.style.opacity = '1';
                    toast.style.transform = 'translate(-50%, -16px)';
                }, 10);

                // è‡ªå‹•éè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
                if (isSuccess !== null) {
                    toastTimeoutId = setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translate(-50%, 0)';
                        setTimeout(() => {
                            if (document.body.contains(toast)) {
                                toast.remove();
                            }
                            if (toastTimeoutId) {
                                toastTimeoutId = null;
                            }
                        }, 1000);
                    }, 3000);
                }
            }, 20);
        }

        /**
         * AIãŒç”Ÿæˆã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä¸è¦ãªéƒ¨åˆ†ï¼ˆMarkdownãªã©ï¼‰ã‚’å–ã‚Šé™¤ã
         * @param {string} text - æ•´å½¢ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {string} æ•´å½¢å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ
         */
        const cleanAndFormatText = (text) => {
            if (!text) return '';
            return text.replace(/```/g, '').trim();
        };

        /**
         * çŒ®ç«‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿæˆã™ã‚‹
         */
        const generateMenuIdea = async () => {
            if (!selectedImageBase64) {
                showToast('ç”»åƒã‚’é¸æŠã—ã¦ã­ï¼', false);
                return;
            }

            // UIã‚’ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆä¸­ã®çŠ¶æ…‹ã«æ›´æ–°
            isGeneratingText = true;
            disableAllButtons();
            promptResultBox.classList.remove('hidden');
            resultText.textContent = '';
            copyBtn.classList.add('hidden');
            galmojiToggleBtn.classList.add('hidden');
            kansaiToggleBtn.classList.add('hidden');
            hakataToggleBtn.classList.add('hidden');
            tsugaruToggleBtn.classList.add('hidden');
            uchinaguchiToggleBtn.classList.add('hidden');
            textLoadingIndicator.classList.remove('hidden');
            promptResultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('charCount').textContent = ''; 
            copyBtnTooltip.textContent = 'çŒ®ç«‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚³ãƒ”ãƒ¼';

            // AIã¸ã®æŒ‡ç¤º
            const imageContext = currentImagePrompt ? `\nã€è£œè¶³æƒ…å ±: ç”»åƒç”Ÿæˆæ™‚ã®è©³ç´°æŒ‡ç¤ºã€‘\n${currentImagePrompt}` : "";
            const systemPrompt = "ã‚ãªãŸã¯å‰µé€ çš„ãªæ–™ç†ç ”ç©¶å®¶ã§ã™ã€‚ç”»åƒã«å†™ã£ã¦ã„ã‚‹æ–™ç†ã‚’ã€Œä¸»èœã€ã¨ã—ã¦ã€æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã¨å½©ã‚Šã‚’è€ƒæ…®ã—ãŸçŒ®ç«‹ã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³ææ¡ˆã—ã¦ãã ã•ã„ã€‚å„çŒ®ç«‹ã«ã¯ã€Œä¸»é£Ÿã€ã€Œå‰¯èœã€ã€Œæ±ç‰©ã€ã‚’å…·ä½“çš„ã«å«ã‚ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°ã€ã€Œã•ã£ã±ã‚Šã¨ã—ãŸå’Œé¢¨çŒ®ç«‹ã€ã€Œã‚¹ã‚¿ãƒŸãƒŠæº€ç‚¹ã®æ´‹é¢¨çŒ®ç«‹ã€ã€Œé‡èœãŸã£ã·ã‚Šã®ãƒ˜ãƒ«ã‚·ãƒ¼çŒ®ç«‹ã€ã®ã‚ˆã†ã«ã€ãƒ†ãƒ¼ãƒã‚’æŒãŸã›ãŸææ¡ˆã‚’ã™ã‚‹ã¨ã€ã‚ˆã‚Šé­…åŠ›çš„ã«ãªã‚Šã¾ã™ã€‚ç®‡æ¡æ›¸ãã§åˆ†ã‹ã‚Šã‚„ã™ãæç¤ºã—ã¦ãã ã•ã„ã€‚";
            const userPrompt = `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹æ–™ç†ã«åˆã†çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
                ${imageContext}
                â€»ã“ã®æŒ‡ç¤ºã§ç”Ÿæˆã•ã‚ŒãŸç”»åƒã§ã‚ã‚‹ã“ã¨ã‚’è€ƒæ…®ã—ã€å…·ä½“çš„ãªé£Ÿæã‚’æ´»ã‹ã—ãŸææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚`;

            try {
                const generatedText = await generateTextFromImage(selectedImageBase64, systemPrompt, userPrompt);

                // ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                const formattedText = cleanAndFormatText(generatedText);
                resultText.textContent = formattedText;
                copyBtn.classList.remove('hidden');
            } catch (error) {
                console.error('ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                let errorMessage = `ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                if (error.message.includes('APIèªè¨¼ã‚¨ãƒ©ãƒ¼')) {
                    errorMessage = 'ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIèªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                }
                resultText.textContent = errorMessage;
            } finally {
                // UIã‚’é€šå¸¸çŠ¶æ…‹ã«æˆ»ã™
                isGeneratingText = false;
                enableAllButtons();
                textLoadingIndicator.classList.add('hidden');
            }
        };

        /**
         * é£Ÿãƒ¬ãƒã‚’ç”Ÿæˆã™ã‚‹
         */
        const generateFoodReview = async () => {
            if (!selectedImageBase64) {
                showToast('ç”»åƒã‚’é¸æŠã—ã¦ã­ï¼', false);
                return;
            }

            // UIã‚’ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆä¸­ã®çŠ¶æ…‹ã«æ›´æ–°
            isGeneratingText = true;
            disableAllButtons();
            promptResultBox.classList.remove('hidden');
            resultText.textContent = '';
            copyBtn.classList.add('hidden');
            galmojiToggleBtn.classList.add('hidden');
            kansaiToggleBtn.classList.add('hidden');
            hakataToggleBtn.classList.add('hidden');
            tsugaruToggleBtn.classList.add('hidden');
            uchinaguchiToggleBtn.classList.add('hidden');
            textLoadingIndicator.classList.remove('hidden'); 
            promptResultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('charCount').textContent = ''; 
            copyBtnTooltip.textContent = 'é£Ÿãƒ¬ãƒã‚³ãƒ”ãƒ¼';

            try {
                // 1æ®µéšç›®ï¼šæ–™ç†ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’åˆ¤å®š
                const categorySystemPrompt = `ã‚ãªãŸã¯æ–™ç†ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’åˆ¤å®šã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ç”»åƒã‹ã‚‰æ–™ç†ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’åˆ¤æ–­ã—ã€ä»¥ä¸‹ã®3ã¤ã®ã†ã¡æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’ä¸€ã¤ã ã‘æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚ä½™è¨ˆãªèª¬æ˜ã‚„æ–‡ç« ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚`;
                const categoryUserPrompt = `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹æ–™ç†ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯ã€Œã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ã‚¯ç³»ã€ã€Œç¹Šç´°ãƒ»é«˜ç´šç³»ã€ã€Œä¸­é–“ãƒ»æ±ç”¨ç³»ã€ã®ã©ã‚Œã«æœ€ã‚‚è¿‘ã„ã§ã™ã‹ï¼Ÿ`;
                const categoryText = await generateTextFromImage(selectedImageBase64, categorySystemPrompt, categoryUserPrompt);

                if (!categoryText) {
                    throw new Error('æ–™ç†ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }

                // 2æ®µéšç›®ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å¿œã˜ãŸé£Ÿãƒ¬ãƒã‚’ç”Ÿæˆ
                const length = parseInt(lengthSelect.value, 10);

                // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆç´„22æ–‡å­—ï¼‰ã®åˆ†ã‚’è€ƒæ…®ã—ã¦ã€æœ¬æ–‡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ±ºã‚ã‚‹
                const tagLength = 25; 
                const maxBodyLength = length - tagLength;
                const minBodyLength = maxBodyLength - 20;

                // æ–‡å­—æ•°æŒ‡ç¤º
                const lengthInstruction = `
                #å³å®ˆäº‹é …:
                ã‚ãªãŸã¯æ–‡ç« ã®æ¨æ•²ã¨æ–‡å­—æ•°èª¿æ•´ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚
                æœ€çµ‚çš„ãªå‡ºåŠ›ã¯ã€å¿…ãšä»¥ä¸‹ã® #æ–‡å­—æ•° æ¡ä»¶ã‚’**1æ–‡å­—ã®ç‹‚ã„ã‚‚ãªã**æº€ãŸã•ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

                #æ–‡å­—æ•°:
                ãƒ»æœ¬æ–‡ã®ä¸‹é™: ${minBodyLength}å­—
                ãƒ»æœ¬æ–‡ã®ä¸Šé™: ${maxBodyLength}å­— (è¶…éã¯å³ã‚¨ãƒ©ãƒ¼ã¨ã¿ãªã—ã¾ã™)
                â€»å¥èª­ç‚¹ã€è¨˜å·ã€æ”¹è¡Œã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã™ã¹ã¦å«ã‚ãŸåˆè¨ˆæ–‡å­—æ•°ã§ã™ã€‚

                #ç”Ÿæˆæ‰‹é †:
                1. ã¾ãšç”»åƒã«åŸºã¥ãã€æœ€é«˜ã®é£Ÿãƒ¬ãƒã‚’è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆåˆæœŸãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ã€‚
                2. ãƒ‰ãƒ©ãƒ•ãƒˆã®æ–‡å­—æ•°ã‚’å³å¯†ã«ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
                3. ã‚«ã‚¦ãƒ³ãƒˆã—ãŸæ–‡å­—æ•°ãŒ ${minBodyLength}ï½${maxBodyLength} æ–‡å­—ã®ç¯„å›²ã«åã¾ã‚‹ã¾ã§ã€ç„¡é§„ãªä¿®é£¾èªã‚’å‰Šã‚‹ã‹ã€æå†™ã‚’è£œè¶³ã—ã¦å¾¹åº•çš„ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
                4. æœ€çµ‚çš„ã«æ¡ä»¶ã‚’å®Œç’§ã«æº€ãŸã—ãŸæ–‡ç« **ã®ã¿**ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                5. ãƒ—ãƒ­ã‚»ã‚¹ã‚„ã‚«ã‚¦ãƒ³ãƒˆçµæœã¯å‡ºåŠ›ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚`;

                // --- ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®å½¹å‰²å®šç¾© ---
                let systemPrompt;

                // å…±é€šã®æ–‡ä½“æŒ‡ç¤ºï¼ˆã™ã¹ã¦ã®ã‚¹ã‚¿ã‚¤ãƒ«ã«é©ç”¨ã—ã¦ã“ãªã‚Œæ„Ÿã‚’å‡ºã™ï¼‰
                const nuanceInstruction = `
                #è¡¨ç¾ã®æŒ‡é‡:
                ãƒ»ã€Œè¦‹ã¦ãã ã•ã„ï¼ã€ã€Œã‚ï½ï¼ã€ã¨ã„ã£ãŸå®šå‹æ–‡ã‚„ã€ã‚«ãƒ¡ãƒ©ã‚’æ„è­˜ã—ã™ããŸå®Ÿæ³ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
                ãƒ»ä¸€å£ã”ã¨ã«æº¢ã‚Œã‚‹ã€Œè‡ªåˆ†ã®æœ¬éŸ³ã€ã‚’å®Ÿæ³ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ãŒç†æƒ³ã§ã™ã€‚
                ãƒ»ã€Œï½ã§ã™ã€ã€Œï½ã¾ã™ã€ã®é€£ç¶šã‚’é¿ã‘ã€é©åº¦ã«ã€ä½“è¨€æ­¢ã‚ã€‘ã‚„ã€æ„Ÿå˜†ï¼ˆã€Œã‚ãã€ãŸã¾ã‚‰ã‚“ã€ã€Œã“ã‚Œã“ã‚Œã€ãªã©ï¼‰ã€‘ã‚’æ··ãœã€ãƒªã‚ºãƒ ã‚’ä½œã£ã¦ãã ã•ã„ã€‚
                ãƒ»SNSã§æ€ã‚ãšæ‰‹ãŒæ­¢ã¾ã‚‹ã‚ˆã†ãªã€ç”ŸããŸè¨€è‘‰ã€æ¸©åº¦æ„Ÿã®ã‚ã‚‹è¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`;

                if (categoryText.includes("ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ã‚¯ç³»")) {
                    systemPrompt = `ã‚ãªãŸã¯é£Ÿã«ã“ã ã‚ã‚ŠãŒå¼·ã„ã€SNSã§å¤§äººæ°—ã®ã‚°ãƒ«ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã§ã™ã€‚
                ç›´æ„Ÿçš„ãªå¿«æ¥½ã¨ã€ã‚«ãƒ­ãƒªãƒ¼ã¸ã®ç½ªæ‚ªæ„Ÿã‚’çªãæŠœã‘ã‚‹ã‚ˆã†ãªã€Œæœ¬éŸ³ã®é£Ÿæ¬²ã€ã‚’ç¶´ã£ã¦ãã ã•ã„ã€‚
                èª­è€…ã«æ•™ãˆã‚‹ã®ã§ã¯ãªãã€è‡ªåˆ†ã®æ„Ÿå‹•ã‚’ç‹¬ã‚Šè¨€ã®ã‚ˆã†ã«å…±æœ‰ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ãŒç†æƒ³ã§ã™ã€‚
                ${nuanceInstruction}
                ${lengthInstruction}`;

                } else if (categoryText.includes("ç¹Šç´°ãƒ»é«˜ç´šç³»")) {
                    systemPrompt = `ã‚ãªãŸã¯ç¾é£Ÿç•ªçµ„ã®ãƒ™ãƒ†ãƒ©ãƒ³ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼ã§ã™ãŒã€ä»Šå›ã¯ç§çš„ãªSNSæŠ•ç¨¿ã¨ã—ã¦æ›¸ã„ã¦ãã ã•ã„ã€‚
                æ´—ç·´ã•ã‚ŒãŸè¨€è‘‰é¸ã³ã®ä¸­ã«ã€ãƒ—ãƒ­ã§ã‚‚æ€ã‚ãšå”¸ã£ã¦ã—ã¾ã†ã‚ˆã†ãªã€ŒçœŸå®Ÿå‘³ã®ã‚ã‚‹æ„Ÿå‹•ã€ã‚’è¾¼ã‚ã¦ãã ã•ã„ã€‚
                éå‰°ãªé£¾ã‚Šè¨€è‘‰ã¯é¿ã‘ã€ç´ æã®åŠ›ã‚„è·äººã®æŠ€ã‚’ã€é™ã‹ãªç†±é‡ã§æå†™ã—ã¦ãã ã•ã„ã€‚
                ${nuanceInstruction}
                ${lengthInstruction}`;

                } else {
                    systemPrompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚°ãƒ«ãƒ¡é›‘èªŒã®ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ä»Šå›ã¯ä»•äº‹ã§ã¯ãªãã€è‡ªèº«ã®SNSã§ã®æ´»å‹•ã¨ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚
                èª­è€…ãŒå‘³ã‚„é¦™ã‚Šã‚’è‡ªåˆ†ã®ã“ã¨ã®ã‚ˆã†ã«æƒ³åƒã§ãã‚‹ã€ãƒªã‚¢ãƒ«ã§é­…åŠ›çš„ãªè¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
                å®¢è¦³çš„ãªè§£èª¬ã§ã¯ãªãã€ãã®å ´ã«ã„ã‚‹ã‚ˆã†ãªè‡¨å ´æ„Ÿã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚
                ${nuanceInstruction}
                ${lengthInstruction}`;
                }

                // ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è£œåŠ©æƒ…å ±ã¨ã—ã¦æ¸¡ã™
                const imageContext = currentImagePrompt ? `\nã€è£œè¶³æƒ…å ±: ç”»åƒç”Ÿæˆæ™‚ã®è©³ç´°æŒ‡ç¤ºã€‘\n${currentImagePrompt}` : "";

                const userPrompt = `ã“ã®æ–™ç†ã®é£Ÿãƒ¬ãƒã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚è§£èª¬ã‚„æ–‡å­—æ•°ã¯å«ã‚ãšã€é£Ÿãƒ¬ãƒã®æœ¬æ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                    ${imageContext}
                    â€»ä¸Šè¨˜ã®æŒ‡ç¤ºã«åŸºã¥ã„ã¦ç”Ÿæˆã•ã‚ŒãŸç”»åƒã§ã™ã€‚å†…å®¹ã‚’æ­£ã—ãç†è§£ã™ã‚‹ãŸã‚ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚`;

                // ï¼“å›ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã€ãã®ã†ã¡ã®ãƒ™ã‚¹ãƒˆã‚’æ¡ç”¨ã™ã‚‹
                const threshold = length + 50; // åˆæ ¼ãƒ©ã‚¤ãƒ³ã®å£
                let attempts = []; // ç”Ÿæˆã—ãŸå…¨æ–‡ã‚’ä¿å­˜ã—ã¦ãŠããƒªã‚¹ãƒˆ

                for (let i = 1; i <= 3; i++) {
                    // AIã«ç”Ÿæˆã•ã›ã‚‹
                    const reviewText = await generateTextFromImage(selectedImageBase64, systemPrompt, userPrompt);
                    if (!reviewText) continue; // å¤±æ•—ã—ãŸã‚‰æ¬¡ã®è©¦è¡Œã¸

                    // ã‚¿ã‚°ã‚’ãã£ã¤ã‘ãŸã€Œå®Œæˆå½¢ã€ã‚’ä½œã‚‹
                    const fullText = cleanAndFormatText(reviewText) + "\n\n#Gemini #AIart #é£¯ãƒ†ãƒ­";
                    attempts.push(fullText);

                    // æŒ‡å®šæ–‡å­—æ•°ä»¥ä¸‹ãªã‚‰ã€ãã®å ´ã§çµ‚äº†ã—ã¦æ¡ç”¨
                    if (fullText.length <= length) {
                        originalText = fullText;
                        break;
                    }

                    // 3å›çµ‚ã‚ã£ã¦ã‚‚å®Œç’§ãªã®ãŒå‡ºãªã‹ã£ãŸå ´åˆã®æœ€çµ‚åˆ¤æ–­
                    if (i === 3) {
                        // è¨±å®¹ç¯„å›²ï¼ˆ+50ï¼‰ä»¥å†…ã®ã‚‚ã®ãŒ1ã¤ã§ã‚‚ã‚ã‚‹ã‹æ¢ã™
                        const acceptableTexts = attempts.filter(t => t.length <= threshold);
                        if (acceptableTexts.length > 0) {
                            // è¨±å®¹ç¯„å›²å†…ã§ã€Œä¸€ç•ªçŸ­ã„ã‚‚ã®ã€ã‚’æ¡ç”¨
                            originalText = acceptableTexts.reduce((a, b) => a.length < b.length ? a : b);
                        } else if (attempts.length > 0) {
                            // å…¨éƒ¨+50ã‚’è¶…ãˆã¦ãŸã‚‰ã€å…¨è©¦è¡Œã®ä¸­ã§ã€Œä¸€ç•ªçŸ­ã„ã‚‚ã®ã€ã‚’æ¡ç”¨
                            originalText = attempts.reduce((a, b) => a.length < b.length ? a : b);
                            showToast('å°‘ã—é•·ã‚ã«ãªã£ã¡ã‚ƒã£ãŸã‹ã‚‚ï¼èª¿æ•´ã—ã¦ã­ã€‚', false);
                        }
                    }
                }

                // ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ãŸå¾Œã€æœ€çµ‚çš„ã«ãƒ†ã‚­ã‚¹ãƒˆãŒç”Ÿæˆã§ãã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!originalText) {
                    throw new Error('é£Ÿãƒ¬ãƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }

                // è¡¨ç¤ºå‡¦ç†
                resultText.textContent = originalText;
                updateCharCount();

                copyBtn.classList.remove('hidden');
                galmojiToggleBtn.classList.remove('hidden');
                kansaiToggleBtn.classList.remove('hidden');
                hakataToggleBtn.classList.remove('hidden');
                tsugaruToggleBtn.classList.remove('hidden');
                uchinaguchiToggleBtn.classList.remove('hidden');

            } catch (error) {
                console.error('äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                let errorMessage = `äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                if (error.message.includes('APIèªè¨¼ã‚¨ãƒ©ãƒ¼')) {
                    errorMessage = 'äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIèªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                }
                resultText.textContent = errorMessage;
            } finally {
                // UIã‚’é€šå¸¸çŠ¶æ…‹ã«æˆ»ã™
                isGeneratingText = false;
                enableAllButtons();
                textLoadingIndicator.classList.add('hidden');
            }
        };

        /**
         * ç”Ÿæˆé–‹å§‹æ™‚ã®UIçŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
         * @param {boolean} isLoading - ç”Ÿæˆä¸­ã‹
         */
        const setGeneratingUIState = (isLoading) => {
            const buttons = [generateBtn, todaySpecialBtn, seasonalSpecialBtn, trendSpecialBtn];
            buttons.forEach(btn => {
                if (btn) btn.disabled = isLoading;
            });
            if (isLoading) {
                // ç”Ÿæˆé–‹å§‹æ™‚ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºã€å¤ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™
                imageGrid.innerHTML = '';
                loadingIndicator.classList.remove('hidden');
                additionalContent.classList.add('hidden');
                promptResultBox.classList.add('hidden');
            } else {
                // å®Œäº†æ™‚ï¼ˆã‚¨ãƒ©ãƒ¼å«ã‚€ï¼‰ï¼šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éš ã™
                loadingIndicator.classList.add('hidden');
                // â€» generateImageså´ã® finally ã§ success åˆ¤å®šãŒã‚ã‚‹ãŸã‚ã€
                // additionalContent ã®è¡¨ç¤ºã¯ã“ã“ã§ã¯ã‚ãˆã¦è¡Œã‚ãš generateImages ã«ä»»ã›ã¾ã™
            }
        };

        /**
         * ã‚·ã‚§ãƒ•ã®æ°—ã¾ãã‚Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã—ã€è‡ªå‹•ã§ç”Ÿæˆã‚’é–‹å§‹ã™ã‚‹
         * @param {string} type - 'anniversary' (è¨˜å¿µæ—¥), 'seasonal' (å­£ç¯€), 'trend' (ãƒˆãƒ¬ãƒ³ãƒ‰)
         */
        const suggestChefMenu = async (type) => {
            if (generateBtn.disabled) return;
            setGeneratingUIState(true); // UIã®åˆæœŸåŒ–ã¨ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–

            // ç¾åœ¨ã®æ—¥ä»˜æƒ…å ±ã‚’å–å¾—ï¼ˆ2026å¹´æƒ³å®šï¼‰
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;

            let typeContext = "";
            if (type === 'anniversary') {
                typeContext = `${dateStr}ã®ã€Œä»Šæ—¥ã¯ä½•ã®æ—¥ã€ã‚„è¨˜å¿µæ—¥ã«ã¡ãªã‚“ã ã€å†™çœŸæ˜ ãˆã™ã‚‹é£Ÿã¹ç‰©ã€‚`;
            } else if (type === 'seasonal') {
                typeContext = `${now.getMonth() + 1}æœˆã®å­£ç¯€æ„Ÿã€æ—¬ã®é£Ÿæã€ãã®æ™‚æœŸã®å¤©å€™ã«ã´ã£ãŸã‚Šã®å½©ã‚Šè±Šã‹ãªé£Ÿã¹ç‰©ã€‚`;
            } else if (type === 'trend') {
                typeContext = `ç¾åœ¨SNSã§ãƒã‚ºã£ã¦ã„ã‚‹ã€ã‚ã‚‹ã„ã¯é£Ÿé€šã®é–“ã§è©±é¡Œã®ã€è¦‹ãŸç›®ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒå¼·ã„æœ€æ–°ãƒ•ãƒ¼ãƒ‰ãƒˆãƒ¬ãƒ³ãƒ‰ã€‚`;
            }

            const systemPrompt = "ã‚ãªãŸã¯ãƒˆãƒ¬ãƒ³ãƒ‰ã«æ•æ„Ÿãªå‡„è…•ã‚·ã‚§ãƒ•å…¼ã€é£Ÿã®ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æç¤ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒã«æœ€é©ãªæ–™ç†ã‚’1ã¤ã ã‘ææ¡ˆã—ã¦ãã ã•ã„ã€‚";
            const userPrompt = `ãƒ†ãƒ¼ãƒ: ${typeContext}
                ä¸Šè¨˜ãƒ†ãƒ¼ãƒã«åˆã†ã€Œæ–™ç†åã€ã¨ã€ãã®æ–™ç†ãŒæœ€ã‚‚ç¾å‘³ã—ãã†ã«è¦‹ãˆã‚‹ã€ŒèƒŒæ™¯ã‚„ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚’è€ƒãˆã¦ãã ã•ã„ã€‚

                å‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿ã§è¡Œã£ã¦ãã ã•ã„ã€‚
                {"food": "æ–™ç†å", "background": "èƒŒæ™¯ã‚„ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³"}`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json" // ç¢ºå®Ÿã«JSONã§å—ã‘å–ã‚‹
                }
            };

            try {
                // ãƒ†ã‚­ã‚¹ãƒˆç”ŸæˆAPIã‚’å‘¼ã³å‡ºã—
                const response = await fetchWithRetry(() => fetch(LLM_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                const suggestionText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!suggestionText) throw new Error('ã‚·ã‚§ãƒ•ãŒä¸åœ¨ã®ã‚ˆã†ã§ã™');

                const suggestion = JSON.parse(suggestionText);

                // å…¥åŠ›æ¬„ã«åæ˜ 
                promptInput.value = suggestion.food;
                backgroundInput.value = suggestion.background;

                showToast(`ğŸ‘©ğŸ»â€ğŸ³ï¼š${suggestion.food.length > 20 ? suggestion.food.substring(0, 20) + "..." : suggestion.food}`, true);

                await generateImages(suggestion.food);

            } catch (error) {
                console.error('ææ¡ˆã‚¨ãƒ©ãƒ¼:', error);
                showToast('ã‚·ã‚§ãƒ•ãŒä»•è¾¼ã¿ä¸­ã¿ãŸã„ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ï¼', false);
                setGeneratingUIState(false);
            }
        };

        /**
         * Base64ç”»åƒã‚’Firebase Cloud Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’è¿”ã™
         * @param {string} base64Image - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿
         * @param {string} userId - èªè¨¼æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (user.uid)
         * @returns {Promise<string>} ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªURL
         */
        async function uploadToCloudStorage(base64Image, userId) {
            if (!userId || userId === 'èªè¨¼ä¸­...') {
                throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç”»åƒã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚");
            }

            // Cloud Storageå†…ã®ä¿å­˜ãƒ‘ã‚¹ã‚’æ±ºå®š (ä¾‹: users/{userId}/{timestamp}.png)
            const timestamp = Date.now();
            const storageRef = ref(storage, `users/${userId}/${timestamp}.png`);

            // Base64ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (data_urlå½¢å¼ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
            const dataUrl = `data:image/png;base64,${base64Image}`;

            // Base64ã§ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            const snapshot = await uploadString(storageRef, dataUrl, 'data_url');

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
            const downloadURL = await getDownloadURL(snapshot.ref);

            return downloadURL;
        }

        // ã‚®ãƒ£ãƒ«æ–‡å­—ON/OFFãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
        galmojiToggleBtn.addEventListener('click', () => {
            if (!originalText) {
                showToast('å…ˆã«ã€Œé£Ÿãƒ¬ãƒç”Ÿæˆã€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚', false);
                return;
            }
            if (currentTransformMode === 'galmoji') {
                resetAllToggleButtons();
            } else {
                resetAllToggleButtons();
                currentTransformMode = 'galmoji';
                galmojiToggleBtn.classList.remove('text-gray-400');
                galmojiToggleBtn.classList.add('text-pink-400');
                // ã‚®ãƒ£ãƒ«æ–‡å­—å¤‰æ›ã‚’å®Ÿè¡Œ
                const [body, hashtags] = originalText.split('\n\n#Gemini');
                const convertedBody = convertToGalmoji(body);
                resultText.textContent = convertedBody + '\n\n#Gemini' + hashtags;
                updateCharCount();
            }
        });

        // æ–¹è¨€åˆ‡ã‚Šæ›¿ãˆã®å…±é€šå‡¦ç†
        const handleDialectClick = async (dialect, buttonElem, activeClass) => {
            if (!originalText) {
                showToast('å…ˆã«ã€Œé£Ÿãƒ¬ãƒç”Ÿæˆã€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚', false);
                return;
            }

            if (currentTransformMode === dialect) {
                resetAllToggleButtons();
            } else {
                resetAllToggleButtons();
                currentTransformMode = dialect;
                buttonElem.classList.remove('text-gray-400');
                buttonElem.classList.add(activeClass);
                
                // ç¿»è¨³å®Ÿè¡Œï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ã™ãè¿”ã£ã¦ãã‚‹ï¼‰
                await translateWithAI(dialect);
            }
        };

        /**
         * AIã‚’ä½¿ã£ã¦æ–¹è¨€ã«ç¿»è¨³ã™ã‚‹ï¼ˆåˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å…¨æ–¹è¨€ã‚’ä¸€æ‹¬ç¿»è¨³ï¼‰
         * @param {string} dialect - è¡¨ç¤ºã—ãŸã„æ–¹è¨€å
         */
        const translateWithAI = async (dialect) => {
            // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆæ—¢ã«ã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã—ã¦çµ‚äº†ï¼‰
            if (translatedTextCache[dialect]) {
                resultText.textContent = translatedTextCache[dialect];
                updateCharCount();
                return;
            }

            // ã¾ã ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã®ã¿ã€AIã¸ã€Œä¸€æ‹¬ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™
            disableAllButtons();
            textLoadingIndicator.classList.remove('hidden');

            try {
                // ã‚¿ã‚°ã‚’ä¿è­·
                const parts = originalText.split('\n\n#Gemini');
                const bodyText = parts[0];
                const hashtags = parts.length > 1 ? '\n\n#Gemini' + parts[1] : '';

                // ä¸€æ‹¬ç¿»è¨³ç”¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                const systemPrompt = `ã‚ãªãŸã¯æ–¹è¨€å¤‰æ›ã®å°‚é–€å®¶ã§ã™ã€‚å…¥åŠ›ã•ã‚ŒãŸæ—¥æœ¬èªã‚’ã€é–¢è¥¿å¼ã€‘ã€åšå¤šå¼ã€‘ã€æ´¥è»½å¼ã€‘ã€ã†ã¡ãªãƒ¼ãã¡ã€‘ã®4ç¨®é¡ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚
                    å„æ–¹è¨€ã¨ã‚‚æ„å‘³ã¨æ–‡å­—æ•°ã‚’ç¶­æŒã—ã€ä½™è¨ˆãªè§£èª¬ã¯å«ã¾ãšã€å¿…ãšä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
                    {"é–¢è¥¿å¼":"...","åšå¤šå¼":"...","æ´¥è»½å¼":"...","ã†ã¡ãªãƒ¼ãã¡":"..."}`;

                const payload = {
                    contents: [{ parts: [{ text: bodyText }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" } // JSONãƒ¢ãƒ¼ãƒ‰
                };

                const response = await fetchWithRetry(() => fetch(TRANSLATION_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                // JSONè§£æã‚¨ãƒ©ãƒ¼å¯¾ç­–
                let translations;
                try {
                    translations = JSON.parse(jsonText);
                } catch (e) {
                    // ä¸‡ãŒä¸€JSONä»¥å¤–ã®æ–‡å­—ãŒæ··ã–ã£ã¦ã„ãŸå ´åˆã®æŠ½å‡º
                    const jsonMatch = jsonText.match(/\{.*\}/s);
                    if (jsonMatch) {
                        translations = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error("JSONå½¢å¼ã§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    }
                }

                // å…¨æ–¹è¨€ã‚’ä¸€æ°—ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                const dialectKeys = ['é–¢è¥¿å¼', 'åšå¤šå¼', 'æ´¥è»½å¼', 'ã†ã¡ãªãƒ¼ãã¡'];
                dialectKeys.forEach(key => {
                    if (translations[key]) {
                        translatedTextCache[key] = translations[key] + hashtags;
                    }
                });

                // ä»Šå›ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ–¹è¨€ã‚’è¡¨ç¤º
                if (translatedTextCache[dialect]) {
                    resultText.textContent = translatedTextCache[dialect];
                    updateCharCount();
                }

            } catch (error) {
                console.error(`ä¸€æ‹¬ç¿»è¨³ã‚¨ãƒ©ãƒ¼:`, error);
                showToast(`ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, false);
                resultText.textContent = originalText; 
                resetAllToggleButtons();
            } finally {
                enableAllButtons();
                textLoadingIndicator.classList.add('hidden');
            }
        };

        // æ–‡å­—æ•°è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        const updateCharCount = () => {
            document.getElementById('charCount').textContent = `${resultText.textContent.length} æ–‡å­—`;
        };

        // --- UIæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        /**
         * å…¨ã¦ã®æ“ä½œãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
         */
        const disableAllButtons = () => {
            const buttons = [generateBtn, todaySpecialBtn, seasonalSpecialBtn, trendSpecialBtn];
            buttons.forEach(btn => {
                if (btn) btn.disabled = true;
            });
            document.querySelectorAll('.llm-button, .llm-select').forEach(el => el.disabled = true);
        };

        /**
         * å…¨ã¦ã®æ“ä½œãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
         */
        const enableAllButtons = () => {
            const buttons = [generateBtn, todaySpecialBtn, seasonalSpecialBtn, trendSpecialBtn];
            buttons.forEach(btn => {
                if (btn) btn.disabled = false;
            });
            document.querySelectorAll('.llm-button, .llm-select').forEach(el => el.disabled = false);
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---

        // ã€Œé£¯ãƒ†ãƒ­ç”Ÿæˆã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
        generateBtn.addEventListener('click', () => {
            resetAllToggleButtons();
            translatedTextCache = {};
            const prompt = promptInput.value;
            if (prompt.trim() !== '') {
                generateImages(prompt);
            }
        });

        // å…¥åŠ›æ¬„ã§Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸæ™‚
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateBtn.click();
            }
        });
        backgroundInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateBtn.click();
            }
        });

        // ã€Œé£Ÿãƒ¬ãƒç”Ÿæˆã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
        reviewBtn.addEventListener('click', async () => {
            resetAllToggleButtons();
            translatedTextCache = {};
            await generateFoodReview();
        });

        // ã€ŒçŒ®ç«‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
        menuBtn.addEventListener('click', () => {
            resetAllToggleButtons();
            translatedTextCache = {};
            generateMenuIdea();
        });

        // ã‚®ãƒ£ãƒ«æ–‡å­—ãƒ»æ–¹è¨€ãƒ¢ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        const resetAllToggleButtons = () => {
            currentTransformMode = null;
            resultText.textContent = originalText;
            updateCharCount();

            // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®è‰²ã¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const allToggleButtons = [galmojiToggleBtn, kansaiToggleBtn, hakataToggleBtn, tsugaruToggleBtn, uchinaguchiToggleBtn];
            allToggleButtons.forEach(btn => {
                btn.classList.remove('text-pink-400', 'text-emerald-400', 'text-purple-400', 'text-sky-400', 'text-orange-400');
                btn.classList.add('text-gray-400');
            });
        };

        // æ–‡ç« ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
        copyBtn.addEventListener('click', (event) => {
            copyToClipboard(resultText.textContent, event.currentTarget);
        });

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
        promptCopyBtn.addEventListener('click', (event) => {
            if (currentImagePrompt) {
                copyToClipboard(currentImagePrompt, event.currentTarget);
            } else {
                showToast('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚', false);
            }
        });

        /**
         * ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆãƒ»æ¼¢å­—ã‚’ã‚®ãƒ£ãƒ«æ–‡å­—ã«ãƒ©ãƒ³ãƒ€ãƒ å¤‰æ›ã™ã‚‹é–¢æ•°
         * @param {string} text - å¤‰æ›å¯¾è±¡ã®æ–‡å­—åˆ—
         * @returns {string} - å¤‰æ›ã•ã‚ŒãŸã‚®ãƒ£ãƒ«æ–‡å­—ã®æ–‡å­—åˆ—
         */
        const convertToGalmoji = (text) => {
            // ã‚®ãƒ£ãƒ«æ–‡å­—ã®å¤‰æ›ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ãŸãƒãƒƒãƒ—
            const galmojiMap = {
                'ç¾':['ç‹è¦‹'], 'ç§‘':['ç¦¾æ–—'], 'ç§':['ç¦¾ï¾‘'], 'å¶':['ï¾›å'], 'å½¹':['ï¾ƒæ®³'],
                'ä¾‹':['ï½²æ­¹ï¾˜'], 'è¿‘':['è¾¶æ–¤'], 'å¥':['ï½²å»´è¿'], 'æœ‰':['ï¾…æœˆ'], 'å':['ï¾€ã€‚'],
                'æ°·':['âŠƒiâŠ‚','ï¾—|ï¼œ'], 'å¤©':['æ— '], 'æœ¬':['å¤²'], 'æ¥':['ä¾†'], 'ç¥':['ï¾ˆç”³'],
                'è¶…':['èµ°å¬'], 'æ—':['æœ¨æœ¨'], 'æ ¡':['æœ¨äº¤'], 'çµ¶':['ç³¸è‰²'], 'ç´š':['ç³¸åŠ'],
                'é‰„':['é‡‘å¤±','é‡‘çŸ¢'], 'æŸ¿':['æœ¨å¸‚'], 'ä»”':['ï½²å­'], 'æ„›ã—ã¦ã‚‹':['æ„›Î¹Ï„ã‚‘','æ„›UÏ„ã‚‘'],
                'ä»²è‰¯ã—':['äººãŠ¥ã‚‡U','ã‚¤ãŠ¥å¤œæ­¹ï¾‹','ä»²ä»”'], 'è¬':['è¨€èº«å¯¸'], 'çµ‚':['ç³¸å†¬'], 'å¯¾':['æ–‡å¯¸'],
                'ä¾¿':['ã‚¤æ›´æˆ¸æ–¤'], 'æ¡‚':['æœ¨åœ­'], 'å¤§':['å› '], 'äºº':['å›š'], 'æœ¨':['å›°'],
                'å·»':['åœ'], 'å£':['å›'], 'å¹¸':['åœ‰'], 'æ°´':['å›¦'], 'å­':['å›'],
                'å¥³':['å›¡'], 'å¯¸':['å›£'], 'äº•':['å›²'], 'åŒ–':['å›®'], 'å…ƒ':['å›­'],
                'çˆª':['å›³'], 'ä¸':['å›¨'], 'å¤':['å›º'], 'å…«åœŸ':['å›¶'], 'ç‰':['å›½'],
                'ä»¤':['å›¹'], 'å››æ–¹å…«æ–¹':['4ã»ã…åœ€'], 'æœ‰':['å›¿'], 'æ›¸':['åœ•'], 'å¹¸':['åœ‰'],
                'å“¡':['åœ“'], 'æ—¥':['Î˜','æ›°'], 'ä¸­':['Î¦','ãŠ¥'], 'ãƒãƒ¼ãƒˆ':['å‡'], 'è¡Œ':['ï¾ƒï¾ƒ','ã€’ã€’'],
                'çµ¦æ–™':['ç³¸åˆç±³æ–—'], 'å°±æ´»':['äº¬å°¤ã‚·èˆŒ'], 'ä»•':['ï½²å£«'], 'ä¼‘':['ï½²æœ¨'],
                'ç¥':['ï¾ˆå…„'], 'èª­':['è¨€å£²'], 'æ¬²':['è°·æ¬ '], 'é¡˜':['åŸé '], 'æœ‹':['æœˆæœˆ'],
                'èª':['è¨€å¾'], 'èª':['è¨€å¿'], 'ç¶š':['ç³¸å£²'], 'ä½¿':['ï½²å'], 'æ­»':['ï¾€ï¾‹'],
                'ä¸Š':['ãŠ¤'], 'ä¸‹':['ãŠ¦'], 'å·¦':['ãŠ§','ï¾…ï½ª'], 'å³':['ãŠ¨'], 'å°':['ãŠ','Eå©'],
                'ã¾ã˜':['ã¾ã¢'], 'ã¦ã‚†ã†ã‹':['ãƒƒå¡š'], 'ï½ã¦è¨€ã£ã¦ã„ã¦':['ï½ãƒƒä¹™ã‚†ï½³ã­ã‡'],
                'ã‚':['ã','ã‚¡','äº†'], 'ã„':['ãƒ','ã‚£','ï¾šãƒ½','ï¾šä¸¶','ãƒ¬ï¼‰','ï¾š`','Lä¸¶','L1','ï¾šl'],
                'ã†':['ã…','ã‚¥','å®€','ãƒ´','ã‚¦'], 'ãˆ':['ã‡','ã‚§','ä¹‹','å·¥','ãƒ±'], 'ãŠ':['ã‰','ã‚©','æ‰'],
                'ã‹':['ï½¶ã‚','ï½¶ä¸¶','ï½¶ãƒ½','ãƒµã‚','ï½¶`','ï½¶ã‚','ã‚«'], 'ãŒ':['ãƒµã‚'], 'ã‚¬':['ã‚«ã‚›','åŠ›ã‚›'],
                'ã':['(ï½·','(â‰ ','Lâ‰ ','â€¡'], 'ã':['ï¼œ','ã€ˆ','å‹¹'], 'ã‘':['ãƒ¶','(ï¾…','ï¾šâ€ ','ï¾šï¾…','|ãƒŠ','l+','Iï¾…'],
                'ã“':['ã€“','=','L','âŠƒ','âŠ‡'], 'ã•':['å»¾','Â±','(å','L+','(+','ï¾…'], 'ã—':['Î¹','âˆª','U'],
                'ã™':['ï¿¡','ï¾Œ'], 'ã›':['ä¸–'], 'ã':['Î¾','Î¶','`ï¾‰','ä¸¶/','ãƒ½ä¸¿'],
                'ãŸ':['ï¾…=','+=','â€ ï¾†','ï¾…ï¾†','åã“','â€ ã“','ï¾…âŠ‡','T=','å=','å¤•'],
                'ã¡':['å¹²','åƒ','äº','ã‚ï¼‹'], 'ã¤':['ã£','ãƒƒ','âŠƒ','ï¾‚'], 'ã¦':['Ï„','ã€’','z','ä¹™'],
                'ã¨':['â” ','â”','â”£','â”œ','`âŠ‚','åœ','`c'], 'ãª':['ï¾…ã‚‡','åã‚‡','â€ ã‚‡','ï¾…g','â€ ã‚‡ã‚','å'],
                'ã«':['(ï¾†','|=','ä¸¨ï¾†','L=','I=','ï¼ˆâŠ‡','ãƒ¬ã“','(äºŒ','ã€“','ï¾šï¾†'],
                'ã¬':['Ğ¹u','ã‚'], 'ã­':['Ğ¹Ñ‘'], 'ã®':['/','ä¸¿','Ïƒ','âŠ‚n','ï¼ '],
                'ã¯':['\'`','å…«','lï¿¡','(ï¿¡','ï¾‰|','ï¾‰l','ï¾šï¿¡','ï¾šã‚ˆ'],
                'ãƒ':['ï¾Šã€ƒ'], 'ãƒ‘':['ï¾Šo'], 'ã²':['åŒ•'], 'ãƒ“':['ï¾‹ã€ƒ'], 'ãƒ”':['ï¾‹o'],
                'ãµ':['ãƒ´',',Î¶'], 'ãƒ–':['ï¾Œã€ƒ'], 'ãƒ—':['ï¾Œo'], 'ã¸':['ï½','âˆ§'], 'ã¹':['ï¾ã€ƒ'],
                'ãƒš':['ï¾o'], 'ã»':['æœ®','ï¾šã¾'], 'ãƒœ':['ï¾ã€ƒ'], 'ãƒ':['ï¾o'],
                'ã¾':['Ğ¼Ğ°','Ğ¼Î±'], 'ã¿':['å½¡','ã‚'], 'ã‚€':['ï¿¡','å¶'], 'ã‚':['Ã—','x','Ï‡','ä¹‚','ã€†'],
                'ã‚‚':['Ğ¼â—‹','Ğ¼Ïƒ','=ã—','=L'], 'ã‚„':['ã‚ƒ','ãƒ£'], 'ã‚†':['ã‚…','ãƒ¥'],
                'ã‚ˆ':['ã‚‡','ãƒ§','âˆ‹','Ñ‡o','âˆƒ'], 'ã‚‰':['ÑĞ°','Î¶','b`'],
                'ã‚Š':['L|','l)','ï¾šï½£','ï¾š)','â”—ã€','â””ä¸¿','v)','ï¾šï½£','ä¸¶)'],
                'ã‚‹':['ã‚','ã‚‘','å„¿','lï¾š','ï½£ãƒ¬','ï½œï¾š','ï¾‰ï¾š','/ï¾š'], 'ã‚Œ':['ÑÑ‘'], 'ã‚':['Ğ·','Ğ—','å›'],
                'ã‚':['ã‚','ãƒ®','wÎ±'], 'ã‚’':['Ñ‰o','ã‰','Îµ'], 'ã‚“':['Ï‰','å†«','w','h','ï¾','ï½¿'],
                'ï¾':['ã€ƒ','â€','Â¨'], 'ãƒ¼':['â†’','â‡’'], 'ã€‚':['o','â—‹'],
                // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ
                'A': ['é—©', 'æœˆ', 'Ğ”', 'Ğ´', 'ï¼ ', 'Ã…', 'âˆ€'],
                'B': ['å•', 'å®˜', 'â™­', 'Ğ²', 'ÑŒ'],
                'C': ['åŒš', 'åŒ¸', 'ï¿ ', 'âŠ‚', 'â„ƒ'],
                'D': ['å›™'],
                'E': ['ãƒ¨', 'å·¨', 'è‡£', 'å·³', 'ã…Œ', 'Ñ‘'],
                'F': ['å­’', 'ä¸‹'],
                'G': ['âŠ‚â”', 'Câ”'],
                'H': ['ä¸©', 'Ğ½'],
                'I': ['å·¥', 'ï½œ'],
                'J': ['ã—', 'ã€', 'ã€'],
                'K': ['|ã', 'Îº'],
                'L': ['â””', 'ï½œ'],
                'M': ['ä»', 'ï¾', 'å·', 'ç“œ', 'Ğ¼'],
                'N': ['å†‚', 'âˆ©', 'Ğ¸', 'Ğ˜'],
                'O': ['å£', 'â—‹', 'Î¿'],
                'P': ['å°¸', 'Ï'],
                'Q': ['ç”µ', 'Oã€'],
                'R': ['å°º', 'Î³', 'Ñ', 'Ğ¯'],
                'S': ['ä¸‚', 'ï¼„', 'âˆ«'],
                'T': ['ä¸', 'ã¦', 'å', 'Ñ‚'],
                'U': ['å‡µ', 'âˆª', 'Ñ†'],
                'V': ['ãƒ¬', 'âˆ¨'],
                'W': ['å±±', 'Ñˆ', 'Ñ‰', 'Ğ¨', 'Ğ©'],
                'X': ['ä¹‚', 'Ï‡', 'Ã—'],
                'Y': ['ã‚½', 'ï¿¥', 'Ñ‡', 'Ğ§'],
                'Z': ['ä¹™']
            };

            let convertedText = '';
            for (const char of text) {
                // å¤‰æ›å€™è£œãŒã‚ã‚Œã°ã€ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã‚“ã§è¿½åŠ 
                if (galmojiMap[char]) {
                    const options = galmojiMap[char];
                    const randomIndex = Math.floor(Math.random() * options.length);
                    convertedText += options[randomIndex];
                } else {
                    // å¤‰æ›å€™è£œãŒãªã‘ã‚Œã°ã€ãã®ã¾ã¾è¿½åŠ 
                    convertedText += char;
                }
            }
            return convertedText;
        };

    </script>
</body>
</html>
